\chapter{Toolbox}\label{cha:toolbox}

\section{Introduction}

The layered structure of ggplot2 encourages you to design and construct
graphics in a structured manner. You've learned the basics in the
previous chapter, and in this chapter you'll get a more comprehensive
task-based introduction. The goal here is not to exhaustively explore
every option of every geom, but instead to show the most important tools
for a given task. For more information about individual geoms, along
with many more examples illustrating their use, see the documentation.

It is useful to think about the purpose of each layer before it is
added. In general, there are three purposes for a layer:
\index{Layers!strategy}

\begin{itemize}
\item
  To display the \textbf{data}. We plot the raw data for many reasons,
  relying on our skills at pattern detection to spot gross structure,
  local structure, and outliers. This layer appears on virtually every
  graphic. In the earliest stages of data exploration, it is often the
  only layer.
\item
  To display a statistical \textbf{summary} of the data. As we develop
  and explore models of the data, it is useful to display model
  predictions in the context of the data. Showing the data helps us
  improve the model, and showing the model helps reveal subtleties of
  the data that we might otherwise miss. Summaries are usually drawn on
  top of the data.
\item
  To add additional \textbf{metadata}: context, annotations, and
  references. A metadata layer displays background context, annotations
  that help to give meaning to the raw data, or fixed references that
  aid comparisons across panels. Metadata can be useful in the
  background and foreground.

  A map is often used as a background layer with spatial data.
  Background metadata should be rendered so that it doesn't interfere
  with your perception of the data, so is usually displayed underneath
  the data and formatted so that it is minimally perceptible. That is,
  if you concentrate on it, you can see it with ease, but it doesn't
  jump out at you when you are casually browsing the plot.

  Other metadata is used to highlight important features of the data. If
  you have added explanatory labels to a couple of inflection points or
  outliers, then you want to render them so that they pop out at the
  viewer. In that case, you want this to be the very last layer drawn.
\end{itemize}

This chapter is broken up into the following sections, each of which
deals with a particular graphical challenge. This is not an exhaustive
or exclusive categorisation, and there are many other possible ways to
break up graphics into different categories. Each geom can be used for
many different purposes, especially if you are creative. However, this
breakdown should cover many common tasks and help you learn about some
of the possibilities.

\begin{itemize}
\item
  Basic plot types that produce common, `named' graphics like
  scatterplots and line charts, \hyperref[sec:basics]{link to section}.
\item
  Displaying text, \hyperref[sec:labelling]{link to section}.
\item
  Adding arbitrary additional anotations,
  \hyperref[sec:annotations]{annotations}.
\item
  Working with collective geoms, like lines and polygons, that each
  display multiple rows of data, \hyperref[sec:grouping]{working with
  groups}.
\item
  Surface plots to display 3d surfaces in 2d,
  \hyperref[sec:surface]{link to section}.
\item
  Drawing maps, \hyperref[sec:maps]{link to section}.
\item
  Revealing uncertainty and error, with various 1d and 2d intervals,
  \hyperref[sec:uncertainty]{link to section}.
\item
  Weighted data, \hyperref[sec:weighting]{link to section}.
\end{itemize}

In \hyperref[sec:diamonds]{diamonds}, you'll learn about the diamonds
dataset. The final three sections use this data to discuss techniques
for visualising larger datasets:

\begin{itemize}
\item
  Displaying distributions, continuous and discrete, 1d and 2d, joint
  and conditional, \hyperref[sec:distributions]{link to section}.
\item
  Dealing with overplotting in scatterplots, a challenge with large
  datasets,\\
   \hyperref[sec:overplotting]{link to section}.
\item
  Displaying statistical summaries instead of the raw data,
  \hyperref[sec:summary]{link to section}.
\end{itemize}

The chapter concludes in \hyperref[sec:elsewhere]{other packages} with
some pointers to other useful packages built on top of ggplot2.

\hyperdef{}{sec:basics}{\section{Basic plot types}\label{sec:basics}}

These geoms are the fundamental building blocks of ggplot2. They are
useful in their own right, but are also used to construct more complex
geoms. Most of these geoms are associated with a named plot: when that
geom is used by itself in a plot, that plot has a special name.

Each of these geoms is two dimensional and requires both \texttt{x} and
\texttt{y} aesthetics. All of them understand \texttt{colour} (or
\texttt{color}) and \texttt{size} aesthetics, and the filled geoms (bar,
tile and polygon) also understand \texttt{fill}.

\begin{itemize}
\item
  \texttt{geom\_area()} draws an \textbf{area plot}, which is a line
  plot filled to the y-axis (filled lines). Multiple groups will be
  stacked on top of each other. \index{Area plot} \indexf{geom\_area}
\item
  \texttt{geom\_bar(stat\ =\ "identity")} makes a \textbf{bar chart}. We
  need \texttt{stat\ =\ "identity"} because the default stat
  automatically counts values (so is essentially a 1d geom, see
  \hyperref[sec:distributions]{distributions}. The identity stat leaves
  the data unchanged. Multiple bars in the same location will be stacked
  on top of one another.\index{Barchart} \indexf{geom\_bar}
\item
  \texttt{geom\_line()} makes a \textbf{line plot}. The \texttt{group}
  aesthetic determines which observations are connected; see
  \hyperref[sec:grouping]{grouping} for more detail.
  \texttt{geom\_line()} connects points from left to right;
  \texttt{geom\_path()} is similar but connects points in the order they
  appear in the data. Both \texttt{geom\_line()} and
  \texttt{geom\_path()} also understand the aesthetic \texttt{linetype},
  which maps a categorical variable to solid, dotted and dashed lines.
  \index{Line plot} \indexf{geom\_line} \indexf{geom\_path}
\item
  \texttt{geom\_point()} produces a \textbf{scatterplot}.
  \texttt{geom\_point()} also understands the \texttt{shape} aesthetic.
  \indexf{geom\_point}
\item
  \texttt{geom\_polygon()} draws polygons, which are filled paths. Each
  vertex of the polygon requires a separate row in the data. It is often
  useful to merge a data frame of polygon coordinates with the data just
  prior to plotting. \hyperref[sec:maps]{Drawing maps} illustrates this
  concept in more detail for map data. \indexf{geom\_polygon}
\item
  \texttt{geom\_rect()}, \texttt{geom\_tile()} and
  \texttt{geom\_raster()} draw rectangles. \texttt{geom\_rect()} is
  parameterised by the four corners of the rectangle, \texttt{xmin},
  \texttt{ymin}, \texttt{xmax} and \texttt{ymax}. \texttt{geom\_tile()}
  is exactly the same, but parameterised by the center of the rect and
  its size, \texttt{x}, \texttt{y}, \texttt{width} and \texttt{height}.
  \texttt{geom\_raster()} is a fast special case of
  \texttt{geom\_tile()} used when all the tiles are the same size.
  \index{Image plot} \index{Level plot} \indexf{geom\_tile}.
  \indexf{geom\_rect} \indexf{geom\_raster}
\end{itemize}

Each geom is shown in the code below. Observe the different axis ranges
for the bar, area and tile plots: these geoms take up space outside the
range of the data, and so push the axes out.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}
  \DataTypeTok{x =} \KeywordTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{), }
  \DataTypeTok{y =} \KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{), }
  \DataTypeTok{label =} \KeywordTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{,}\StringTok{"b"}\NormalTok{,}\StringTok{"c"}\NormalTok{)}
\NormalTok{)}
\NormalTok{p <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y, }\DataTypeTok{label =} \NormalTok{label)) +}\StringTok{ }
\StringTok{  }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{y =} \OtherTok{NULL}\NormalTok{) +}\StringTok{ }\CommentTok{# Hide axis label}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{plot.title =} \KeywordTok{element_text}\NormalTok{(}\DataTypeTok{size =} \DecValTok{12}\NormalTok{)) }\CommentTok{# Shrink plot title}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"point"}\NormalTok{)}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_text}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"text"}\NormalTok{)}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{stat =} \StringTok{"identity"}\NormalTok{) +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"bar"}\NormalTok{)}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_tile}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"raster"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/geom-basic-1}%
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/geom-basic-2}%
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/geom-basic-3}%
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/geom-basic-4}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_line}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"line"}\NormalTok{)}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_area}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"area"}\NormalTok{)}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_path}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"path"}\NormalTok{)}
\NormalTok{p +}\StringTok{ }\KeywordTok{geom_polygon}\NormalTok{() +}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"polygon"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/unnamed-chunk-2-1}%
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/unnamed-chunk-2-2}%
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/unnamed-chunk-2-3}%
  \includegraphics[width=0.25\linewidth]{_figures/toolbox/unnamed-chunk-2-4}
\end{figure}

\subsection{Exercises}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  What geoms would you use to draw each of the following named plots?

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Scatterplot
  \item
    Line chart
  \item
    Histogram
  \item
    Bar chart
  \item
    Pie chart
  \end{enumerate}
\item
  What's the difference between \texttt{geom\_path()} and
  \texttt{geom\_polygon()}? What's the difference between
  \texttt{geom\_path()} and \texttt{geom\_line()}?
\item
  What low-level geoms are used to draw \texttt{geom\_smooth()}? What
  about \texttt{geom\_boxplot()} and \texttt{geom\_violin()}?
\end{enumerate}

\hyperdef{}{sec:labelling}{\section{Labels}\label{sec:labelling}}

\index{Labels} \index{Text} \indexf{geom\_text}

Adding text to a plot can be quite tricky. ggplot2 doesn't have all the
answers, but does provide some tools to make your life a little easier.
The main tool is \texttt{geom\_text()}, which adds \texttt{label}s at
the specified \texttt{x} and \texttt{y} positions.

\texttt{geom\_text()} has the most aesthetics of any geom, because there
are so many ways to control the appearance of a text:

\begin{itemize}
\item
  \texttt{family} gives the name of a font. There are only three fonts
  that are guaranteed to work everywhere: ``sans'' (the default),
  ``serif'', or ``mono'':

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \DecValTok{1}\NormalTok{, }\DataTypeTok{y =} \DecValTok{3}\NormalTok{:}\DecValTok{1}\NormalTok{, }\DataTypeTok{family =} \KeywordTok{c}\NormalTok{(}\StringTok{"sans"}\NormalTok{, }\StringTok{"serif"}\NormalTok{, }\StringTok{"mono"}\NormalTok{))}
\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{family, }\DataTypeTok{family =} \NormalTok{family))}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-family-1}
  \end{figure}

  It's trickier to include a system font on a plot because text drawing
  is done differently by each graphics device (GD). There are five GDs
  in common use (\texttt{png()}, \texttt{pdf()}, on screen devices for
  Windows, Mac and Linux), so to have a font work everywhere you need to
  configure five devices in five different ways. Two packages simplify
  the quandary a bit:

  \begin{itemize}
  \item
    showtext, \url{https://github.com/yixuan/showtext}, by Yixuan Qiu,
    makes GD-independent plots by rendering all text as polygons.
  \item
    extrafont, \url{https://github.com/wch/extrafont}, by Winston Chang,
    converts fonts to a standard format that all devices can use.
  \end{itemize}

  Both approaches have pros and cons, so you will to need to try both of
  them and see which works best for your needs. \index{Font!family}
\item
  \texttt{fontface} specifies the face: ``plain'' (the default),
  ``bold'' or ``italic''. \index{Font!face}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \DecValTok{1}\NormalTok{, }\DataTypeTok{y =} \DecValTok{3}\NormalTok{:}\DecValTok{1}\NormalTok{, }\DataTypeTok{face =} \KeywordTok{c}\NormalTok{(}\StringTok{"plain"}\NormalTok{, }\StringTok{"bold"}\NormalTok{, }\StringTok{"italic"}\NormalTok{))}
\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{face, }\DataTypeTok{fontface =} \NormalTok{face))}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-face-1}
  \end{figure}
\item
  You can adjust the alignment of the text with the \texttt{hjust}
  (``left'', ``center'', ``right'', ``inward'', ``outward'') and
  \texttt{vjust} (``bottom'', ``middle'', ``top'', ``inward'',
  ``outward'') aesthetics. The default alignment is centered. One of the
  most useful alignments is ``inward'': it aligns text towards the
  middle of the plot: \index{Font!justification}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}
  \DataTypeTok{x =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\FloatTok{1.5}\NormalTok{),}
  \DataTypeTok{y =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\FloatTok{1.5}\NormalTok{),}
  \DataTypeTok{text =} \KeywordTok{c}\NormalTok{(}
    \StringTok{"bottom-left"}\NormalTok{, }\StringTok{"bottom-right"}\NormalTok{, }
    \StringTok{"top-left"}\NormalTok{, }\StringTok{"top-right"}\NormalTok{, }\StringTok{"center"}
  \NormalTok{)}
\NormalTok{)}
\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y)) +}
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{text))}
\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y)) +}
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{text), }\DataTypeTok{vjust =} \StringTok{"inward"}\NormalTok{, }\DataTypeTok{hjust =} \StringTok{"inward"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-justification-1}%
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-justification-2}
  \end{figure}
\item
  \texttt{size} controls the font size. Unlike most tools, ggplot2 uses
  mm, rather than the usual points (pts). This makes it consistent with
  other size units in ggplot2. (There are 72.27 pts in a inch, so to
  convert from points to mm, just multiply by 72.27 / 25.4).
  \index{Font!size}
\item
  \texttt{angle} specifies the rotation of the text in degrees.
\end{itemize}

You can map data values to these aesthetics, but use restraint: it is
hard to percieve the relationship between variables mapped to these
aesthetics. \texttt{geom\_text()} also has three parameters. Unlike the
aesthetics, these only take single values, so they must be the same for
all labels:

\begin{itemize}
\item
  Often you want to label existing points on the plot. You don't want
  the text to overlap with the points (or bars etc), so it's useful to
  offset the text a little. The \texttt{nudge\_x} and \texttt{nudge\_y}
  parameters allow you to nudge the text a little horizontally or
  vertically:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{trt =} \KeywordTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{), }\DataTypeTok{resp =} \KeywordTok{c}\NormalTok{(}\FloatTok{1.2}\NormalTok{, }\FloatTok{3.4}\NormalTok{, }\FloatTok{2.5}\NormalTok{))}
\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(resp, trt)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"("}\NormalTok{, resp, }\StringTok{")"}\NormalTok{)), }\DataTypeTok{nudge_y =} \NormalTok{-}\FloatTok{0.25}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{3.6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-nudge-1}
  \end{figure}

  (Note that I manually tweaked the x-axis limits to make sure all the
  text fit on the plot.)
\item
  If \texttt{check\_overlap\ =\ TRUE}, overlapping labels will be
  automatically removed. The algorithm is simple: labels are plotted in
  the order they appear in the data frame; if a label would overlap with
  an existing point, it's omitted. This is not incredibly useful, but
  can be handy. \indexc{check\_overlap}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(displ, hwy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{model)) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{8}\NormalTok{)}
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(displ, hwy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{model), }\DataTypeTok{check_overlap =} \OtherTok{TRUE}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-overlap-1}%
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/text-overlap-2}
  \end{figure}
\end{itemize}

A variation on \texttt{geom\_text()} is \texttt{geom\_label()}: it draws
a rounded rectangle behind the text. This makes it useful for adding
labels to plots with busy backgrounds: \indexf{geom\_label}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{label <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}
  \DataTypeTok{waiting =} \KeywordTok{c}\NormalTok{(}\DecValTok{55}\NormalTok{, }\DecValTok{80}\NormalTok{), }
  \DataTypeTok{eruptions =} \KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\FloatTok{4.3}\NormalTok{), }
  \DataTypeTok{label =} \KeywordTok{c}\NormalTok{(}\StringTok{"peak one"}\NormalTok{, }\StringTok{"peak two"}\NormalTok{)}
\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{(faithfuld, }\KeywordTok{aes}\NormalTok{(waiting, eruptions)) +}
\StringTok{  }\KeywordTok{geom_tile}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \NormalTok{density)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_label}\NormalTok{(}\DataTypeTok{data =} \NormalTok{label, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{label))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.65\linewidth]{_figures/toolbox/label-1}
\end{figure}

Labelling data well poses some challenges:

\begin{itemize}
\item
  Text does not affect the limits of the plot. Unfortunately there's no
  way to make this work since a label has an absolute size (e.g.~3 cm),
  regardless of the size of the plot. This means that the limits of a
  plot would need to be different depending on the size of the plot ---
  there's just no way to make that happen with ggplot2. Instead, you'll
  need to tweak \texttt{xlim()} and \texttt{ylim()} based on your data
  and plot size.
\item
  If you want to label many points, it is difficult to avoid overlaps.
  \texttt{check\_overlap\ =\ TRUE} is useful, but offers little control
  over which labels are removed. There are a number of techniques
  available for base graphics, like \texttt{maptools::pointLabel()}, but
  they're not trivial to port to the grid graphics used by ggplot2. If
  all else fails, you may need to manually label points in a drawing
  tool.
\end{itemize}

Text labels can also serve as an alternative to a legend. This usually
makes the plot easier to read because it puts the labels closer to the
data. The \href{https://github.com/tdhock/directlabels}{directlabels}
package, by Toby Dylan Hocking, provides a number of tools to make this
easier: \index{directlabels}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(displ, hwy, }\DataTypeTok{colour =} \NormalTok{class)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{()}

\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(displ, hwy, }\DataTypeTok{colour =} \NormalTok{class)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{show.legend =} \OtherTok{FALSE}\NormalTok{) +}
\StringTok{  }\NormalTok{directlabels::}\KeywordTok{geom_dl}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label =} \NormalTok{class), }\DataTypeTok{method =} \StringTok{"smart.grid"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-3-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-3-2}
\end{figure}

Directlabels provides a number of position methods. \texttt{smart.grid}
is a reasonable place to start for scatterplots, but there are other
methods that are more useful for frequency polygons and line plots. See
the directlabels website,
\url{http://directlabels.r-forge.r-project.org}, for other techniques.

\hyperdef{}{sec:annotations}{\section{Annotations}\label{sec:annotations}}

Annotations add metadata to your plot. But metadata is just data, so you
can use: \index{Annotation} \index{Metadata}

\begin{itemize}
\item
  \texttt{geom\_text()} to add text descriptions or to label points Most
  plots will not benefit from adding text to every single observation on
  the plot, but labelling outliers and other important points is very
  useful. \index{Labels} \indexf{geom\_text}
\item
  \texttt{geom\_rect()} to highlight interesting rectangular regions of
  the plot. \texttt{geom\_rect()} has aesthetics \texttt{xmin},
  \texttt{xmax}, \texttt{ymin} and \texttt{ymax}. \indexf{geom\_rect}
\item
  \texttt{geom\_line()}, \texttt{geom\_path()} and
  \texttt{geom\_segment()} to add lines. All these geoms have an
  \texttt{arrow} parameter, which allows you to place an arrowhead on
  the line. Create arrowheads with \texttt{arrow()}, which has arguments
  \texttt{angle}, \texttt{length}, \texttt{ends} and \texttt{type}.
  \indexf{geom\_line}
\item
  \texttt{geom\_vline()}, \texttt{geom\_hline()} and
  \texttt{geom\_abline()} allow you to add reference lines (sometimes
  called rules), that span the full range of the plot.
  \indexf{geom\_vline} \indexf{geom\_hline} \indexf{geom\_abline}
\end{itemize}

Typically, you can either put annotations in the foreground (using
\texttt{alpha} if needed so you can still see the data), or in the
background. With the default background, a thick white line makes a
useful reference: it's easy to see but it doesn't jump out at you.

To show off the basic idea, we'll draw a time series of unemployment:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(economics, }\KeywordTok{aes}\NormalTok{(date, unemploy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=1\linewidth]{_figures/toolbox/umep-1}
\end{figure}

We can annotate this plot with which president was in power at the time.
There is little new in this code - it's a straightforward manipulation
of existing geoms. There is one special thing to note: the use of
\texttt{-Inf} and \texttt{Inf} as positions. These refer to the top and
bottom (or left and right) limits of the plot. \indexc{Inf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{presidential <-}\StringTok{ }\KeywordTok{subset}\NormalTok{(presidential, start >}\StringTok{ }\NormalTok{economics$date[}\DecValTok{1}\NormalTok{])}

\KeywordTok{ggplot}\NormalTok{(economics) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_rect}\NormalTok{(}
    \KeywordTok{aes}\NormalTok{(}\DataTypeTok{xmin =} \NormalTok{start, }\DataTypeTok{xmax =} \NormalTok{end, }\DataTypeTok{fill =} \NormalTok{party), }
    \DataTypeTok{ymin =} \NormalTok{-}\OtherTok{Inf}\NormalTok{, }\DataTypeTok{ymax =} \OtherTok{Inf}\NormalTok{, }\DataTypeTok{alpha =} \FloatTok{0.2}\NormalTok{, }
    \DataTypeTok{data =} \NormalTok{presidential}
  \NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_vline}\NormalTok{(}
    \KeywordTok{aes}\NormalTok{(}\DataTypeTok{xintercept =} \KeywordTok{as.numeric}\NormalTok{(start)), }
    \DataTypeTok{data =} \NormalTok{presidential,}
    \DataTypeTok{colour =} \StringTok{"grey50"}\NormalTok{, }\DataTypeTok{alpha =} \FloatTok{0.5}
  \NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}
    \KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \NormalTok{start, }\DataTypeTok{y =} \DecValTok{2500}\NormalTok{, }\DataTypeTok{label =} \NormalTok{name), }
    \DataTypeTok{data =} \NormalTok{presidential, }
    \DataTypeTok{size =} \DecValTok{3}\NormalTok{, }\DataTypeTok{vjust =} \DecValTok{0}\NormalTok{, }\DataTypeTok{hjust =} \DecValTok{0}\NormalTok{, }\DataTypeTok{nudge_x =} \DecValTok{50}
  \NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(date, unemploy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{scale_fill_manual}\NormalTok{(}\DataTypeTok{values =} \KeywordTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"red"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=1\linewidth]{_figures/toolbox/unemp-pres-1}
\end{figure}

You can use the same technique to add a single annotation to a plot, but
it's a bit fiddly because you have to create a one row data frame:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{yrng <-}\StringTok{ }\KeywordTok{range}\NormalTok{(economics$unemploy)}
\NormalTok{xrng <-}\StringTok{ }\KeywordTok{range}\NormalTok{(economics$date)}
\NormalTok{caption <-}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\KeywordTok{strwrap}\NormalTok{(}\StringTok{"Unemployment rates in the US have }
\StringTok{  varied a lot over the years"}\NormalTok{, }\DecValTok{40}\NormalTok{), }\DataTypeTok{collapse =} \StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{(economics, }\KeywordTok{aes}\NormalTok{(date, unemploy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}
    \KeywordTok{aes}\NormalTok{(x, y, }\DataTypeTok{label =} \NormalTok{caption), }
    \DataTypeTok{data =} \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \NormalTok{xrng[}\DecValTok{1}\NormalTok{], }\DataTypeTok{y =} \NormalTok{yrng[}\DecValTok{2}\NormalTok{], }\DataTypeTok{caption =} \NormalTok{caption), }
    \DataTypeTok{hjust =} \DecValTok{0}\NormalTok{, }\DataTypeTok{vjust =} \DecValTok{1}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}
  \NormalTok{)}
\end{Highlighting}
\end{Shaded}

It's easier to use the \texttt{annotate()} helper function which creates
the data frame for you: \indexf{annotate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(economics, }\KeywordTok{aes}\NormalTok{(date, unemploy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\DataTypeTok{x =} \NormalTok{xrng[}\DecValTok{1}\NormalTok{], }\DataTypeTok{y =} \NormalTok{yrng[}\DecValTok{2}\NormalTok{], }\DataTypeTok{label =} \NormalTok{caption,}
    \DataTypeTok{hjust =} \DecValTok{0}\NormalTok{, }\DataTypeTok{vjust =} \DecValTok{1}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}
  \NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=1\linewidth]{_figures/toolbox/unnamed-chunk-5-1}
\end{figure}

Annotations, particularly reference lines, are also useful when
comparing groups across facets. In the following plot, it's much easier
to see the subtle differences if we add a reference line.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(}\KeywordTok{log10}\NormalTok{(carat), }\KeywordTok{log10}\NormalTok{(price))) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bin2d}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(~cut, }\DataTypeTok{nrow =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=1\linewidth]{_figures/toolbox/unnamed-chunk-6-1}%
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]

\NormalTok{mod_coef <-}\StringTok{ }\KeywordTok{coef}\NormalTok{(}\KeywordTok{lm}\NormalTok{(}\KeywordTok{log10}\NormalTok{(price) ~}\StringTok{ }\KeywordTok{log10}\NormalTok{(carat), }\DataTypeTok{data =} \NormalTok{diamonds))}
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(}\KeywordTok{log10}\NormalTok{(carat), }\KeywordTok{log10}\NormalTok{(price))) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bin2d}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_abline}\NormalTok{(}\DataTypeTok{intercept =} \NormalTok{mod_coef[}\DecValTok{1}\NormalTok{], }\DataTypeTok{slope =} \NormalTok{mod_coef[}\DecValTok{2}\NormalTok{], }
    \DataTypeTok{colour =} \StringTok{"white"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{1}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(~cut, }\DataTypeTok{nrow =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=1\linewidth]{_figures/toolbox/unnamed-chunk-6-2}
\end{figure}

\hyperdef{}{sec:grouping}{\section{Collective
geoms}\label{sec:grouping}}

Geoms can be roughly divided into individual and collective geoms. An
\textbf{individual} geom draws a distinct graphical object for each
observation (row). For example, the point geom draws one point per row.
A \textbf{collective} geom displays multiple observations with one
geometric object. This may be a result of a statistical summary, like a
boxplot, or may be fundamental to the display of the geom, like a
polygon. Lines and paths fall somewhere in between: each line is
composed of a set of straight segments, but each segment represents two
points. How do we control the assignment of observations to graphical
elements? This is the job of the \texttt{group} aesthetic.
\index{Grouping} \indexc{group} \index{Geoms!collective}

By default, the \texttt{group} aesthetic is mapped to the interaction of
all discrete variables in the plot. This often partitions the data
correctly, but when it does not, or when no discrete variable is used in
a plot, you'll need to explicitly define the grouping structure by
mapping group to a variable that has a different value for each group.

There are three common cases where the default is not enough, and we
will consider each one below. In the following examples, we will use a
simple longitudinal dataset, \texttt{Oxboys}, from the nlme package. It
records the heights (\texttt{height}) and centered ages (\texttt{age})
of 26 boys (\texttt{Subject}), measured on nine occasions
(\texttt{Occasion}). \texttt{Subject} and \texttt{Occassion} are stored
as ordered factors. \index{nlme} \index{Data!Oxboys@\texttt{Oxboys}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{(Oxboys, }\DataTypeTok{package =} \StringTok{"nlme"}\NormalTok{)}
\KeywordTok{head}\NormalTok{(Oxboys)}
\CommentTok{#>   Subject     age height Occasion}
\CommentTok{#> 1       1 -1.0000    140        1}
\CommentTok{#> 2       1 -0.7479    143        2}
\CommentTok{#> 3       1 -0.4630    145        3}
\CommentTok{#> 4       1 -0.1643    147        4}
\CommentTok{#> 5       1 -0.0027    148        5}
\CommentTok{#> 6       1  0.2466    150        6}
\end{Highlighting}
\end{Shaded}

\subsection{Multiple groups, one aesthetic}

In many situations, you want to separate your data into groups, but
render them in the same way. In other words, you want to be able to
distinguish individual subjects, but not identify them. This is common
in longitudinal studies with many subjects, where the plots are often
descriptively called spaghetti plots. For example, the following plot
shows the growth trajectory for each boy (each \texttt{Subject}):
\index{Data!longitudinal} \indexf{geom\_line}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(age, height, }\DataTypeTok{group =} \NormalTok{Subject)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/oxboys-line-1}
\end{figure}

If you incorrectly specify the grouping variable, you'll get a
characteristic sawtooth appearance:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(age, height)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/oxboys-line-bad-1}
\end{figure}

If a group isn't defined by a single variable, but instead by a
combination of multiple variables, use \texttt{interaction()} to combine
them, e.g.
\texttt{aes(group\ =\ interaction(school\_id,\ student\_id))}.
\indexf{interaction}

\subsection{Different groups on different layers}

Sometimes we want to plot summaries that use different levels of
aggregation: one layer might display individuals, while another displays
an overall summary. Building on the previous example, suppose we want to
add a single smooth line, showing the overall trend for \emph{all} boys.
If we use the same grouping in both layers, we get one smooth per boy:
\indexf{geom\_smooth}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(age, height, }\DataTypeTok{group =} \NormalTok{Subject)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method =} \StringTok{"lm"}\NormalTok{, }\DataTypeTok{se =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/layer18-1}
\end{figure}

This is not what we wanted; we have inadvertently added a smoothed line
for each boy. Grouping controls both the display of the geoms, and the
operation of the stats: one statistical transformation is run for each
group.

Instead of setting the grouping aesthetic in \texttt{ggplot()}, where it
will apply to all layers, we set it in \texttt{geom\_line()} so it
applies only to the lines. There are no discrete variables in the plot
so the default grouping variable will be a constant and we get one
smooth:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(age, height)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \NormalTok{Subject)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method =} \StringTok{"lm"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{2}\NormalTok{, }\DataTypeTok{se =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/layer19-1}
\end{figure}

\subsection{Overriding the default grouping}

Some plots have a discrete x scale, but you still want to draw lines
connecting \emph{across} groups. This is the strategy used in
interaction plots, profile plots, and parallel coordinate plots, among
others. For example, imagine we've drawn boxplots of height at each
measurement occasion: \indexf{geom\_boxplot}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(Occasion, height)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/oxbox-1}
\end{figure}

There is one discrete variable in this plot, \texttt{Occassion}, so we
get one boxplot for each unique x value. Now we want to overlay lines
that connect each individual boy. Simply adding \texttt{geom\_line()}
does not work: the lines are drawn within each occassion, not across
each subject:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(Occasion, height)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{() +}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"#3366FF"}\NormalTok{, }\DataTypeTok{alpha =} \FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/oxbox-line-bad-1}
\end{figure}

To get the plot we want, we need to override the grouping to say we want
one line per boy:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(Oxboys, }\KeywordTok{aes}\NormalTok{(Occasion, height)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{() +}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \NormalTok{Subject), }\DataTypeTok{colour =} \StringTok{"#3366FF"}\NormalTok{, }\DataTypeTok{alpha =} \FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.6\linewidth]{_figures/toolbox/oxbox-line-1}
\end{figure}

\subsection{Matching aesthetics to graphic objects}\label{sub:matching}

A final important issue with collective geoms is how the aesthetics of
the individual observations are mapped to the aesthetics of the complete
entity. What happens when different aesthetics are mapped to a single
geometric element? \index{Aesthetics!matching to geoms}

Lines and paths operate on an off-by-one principle: there is one more
observation than line segment, and so the aesthetic for the first
observation is used for the first segment, the second observation for
the second segment and so on. This means that the aesthetic for the last
observation is not used:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \DecValTok{1}\NormalTok{:}\DecValTok{3}\NormalTok{, }\DataTypeTok{y =} \DecValTok{1}\NormalTok{:}\DecValTok{3}\NormalTok{, }\DataTypeTok{colour =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{5}\NormalTok{))}

\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y, }\DataTypeTok{colour =} \KeywordTok{factor}\NormalTok{(colour))) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \DecValTok{1}\NormalTok{), }\DataTypeTok{size =} \DecValTok{2}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{size =} \DecValTok{5}\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y, }\DataTypeTok{colour =} \NormalTok{colour)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \DecValTok{1}\NormalTok{), }\DataTypeTok{size =} \DecValTok{2}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{size =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-7-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-7-2}
\end{figure}

You could imagine a more complicated system where segments smoothly
blend from one aesthetic to another. This would work for continuous
variables like size or colour, but not for discrete variables, and is
not used in ggplot2. If this is the behaviour you want, you can perform
the linear interpolation yourself:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xgrid <-}\StringTok{ }\KeywordTok{with}\NormalTok{(df, }\KeywordTok{seq}\NormalTok{(}\KeywordTok{min}\NormalTok{(x), }\KeywordTok{max}\NormalTok{(x), }\DataTypeTok{length =} \DecValTok{50}\NormalTok{))}
\NormalTok{interp <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}
  \DataTypeTok{x =} \NormalTok{xgrid,}
  \DataTypeTok{y =} \KeywordTok{approx}\NormalTok{(df$x, df$y, }\DataTypeTok{xout =} \NormalTok{xgrid)$y,}
  \DataTypeTok{colour =} \KeywordTok{approx}\NormalTok{(df$x, df$colour, }\DataTypeTok{xout =} \NormalTok{xgrid)$y  }
\NormalTok{)}
\KeywordTok{ggplot}\NormalTok{(interp, }\KeywordTok{aes}\NormalTok{(x, y, }\DataTypeTok{colour =} \NormalTok{colour)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{size =} \DecValTok{2}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{data =} \NormalTok{df, }\DataTypeTok{size =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.65\linewidth]{_figures/toolbox/matching-lines2-1}
\end{figure}

An additional limitation for paths and lines is that line type must be
constant over each individual line. In R there is no way to draw a line
which has varying line type. \indexf{geom\_line} \indexf{geom\_path}

For all other collective geoms, like polygons, the aesthetics from the
individual components are only used if they are all the same, otherwise
the default value is used. It's particularly clear why this makes sense
for fill: how would you colour a polygon that had a different fill
colour for each point on its border? \indexf{geom\_polygon}

These issues are most relevant when mapping aesthetics to continuous
variables, because, as described above, when you introduce a mapping to
a discrete variable, it will by default split apart collective geoms
into smaller pieces. This works particularly well for bar and area
plots, because stacking the individual pieces produces the same shape as
the original ungrouped data:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(class)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(class, }\DataTypeTok{fill =} \NormalTok{drv)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/bar-split-disc-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/bar-split-disc-2}
\end{figure}

If you try to map fill to a continuous variable in the same way, it
doesn't work. The default grouping will only be based on \texttt{class},
so each bar will be given multiple colours. Since a bar can only display
one colour, it will use the default grey. To show multiple colours, we
need multiple bars for each \texttt{class}, which we can get by
overriding the grouping:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(class, }\DataTypeTok{fill =} \NormalTok{hwy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(class, }\DataTypeTok{fill =} \NormalTok{hwy, }\DataTypeTok{group =} \NormalTok{hwy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/bar-split-cont-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/bar-split-cont-2}
\end{figure}

The bars will be stacked in the order defined by the grouping variable.
If you need fine control, you'll need to create a factor with levels
ordered as needed.

\subsection{Exercises}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Draw a boxplot of \texttt{hwy} for each value of \texttt{cyl}, without
  turning \texttt{cyl} into a factor. What extra aesthetic do you need
  to set?
\item
  Modify the following plot so that you get one boxplot per integer
  value value of \texttt{displ}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(displ, cty)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}
\item
  When illustrating the difference between mapping continuous and
  discrete colours to a line, the discrete example needed
  \texttt{aes(group\ =\ 1)}. Why? What happens if that is omitted?
  What's the difference between \texttt{aes(group\ =\ 1)} and
  \texttt{aes(group\ =\ 2)}? Why?
\item
  How many bars are in each of the following plots?

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(drv)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}

\KeywordTok{ggplot}\NormalTok{(mpg, }\KeywordTok{aes}\NormalTok{(drv, }\DataTypeTok{fill =} \NormalTok{hwy, }\DataTypeTok{group =} \NormalTok{hwy)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}

\KeywordTok{library}\NormalTok{(dplyr)  }
\NormalTok{mpg2 <-}\StringTok{ }\NormalTok{mpg %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(hwy) %>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{id =} \KeywordTok{seq_along}\NormalTok{(hwy)) }
\KeywordTok{ggplot}\NormalTok{(mpg2, }\KeywordTok{aes}\NormalTok{(drv, }\DataTypeTok{fill =} \NormalTok{hwy, }\DataTypeTok{group =} \NormalTok{id)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

  (Hint: try adding an outline around each bar with
  \texttt{colour\ =\ "white"})
\item
  Install the babynames package. It contains data about the popularity
  of babynames in the US. Run the following code and fix the resulting
  graph. Why does this graph make me unhappy?

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(babynames)}
\NormalTok{hadley <-}\StringTok{ }\NormalTok{dplyr::}\KeywordTok{filter}\NormalTok{(babynames, name ==}\StringTok{ "Hadley"}\NormalTok{)}
\KeywordTok{ggplot}\NormalTok{(hadley, }\KeywordTok{aes}\NormalTok{(year, n)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

\hyperdef{}{sec:surface}{\section{Surface plots}\label{sec:surface}}

ggplot2 does not support true 3d surfaces. However, it does support many
common tools for representing 3d surfaces in 2d: contours, coloured
tiles and bubble plots. These all work similarly, differing only in the
aesthetic used for the third dimension. \index{Surface plots}
\index{Contour plot} \indexf{geom\_contour} \index{3d}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(faithfuld, }\KeywordTok{aes}\NormalTok{(eruptions, waiting)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_contour}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{z =} \NormalTok{density, }\DataTypeTok{colour =} \NormalTok{..level..))}

\KeywordTok{ggplot}\NormalTok{(faithfuld, }\KeywordTok{aes}\NormalTok{(eruptions, waiting)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_raster}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \NormalTok{density))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-11-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-11-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Bubble plots work better with fewer observations}
\NormalTok{small <-}\StringTok{ }\NormalTok{faithfuld[}\KeywordTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(faithfuld), }\DataTypeTok{by =} \DecValTok{10}\NormalTok{), ]}
\KeywordTok{ggplot}\NormalTok{(small, }\KeywordTok{aes}\NormalTok{(eruptions, waiting)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{size =} \NormalTok{density), }\DataTypeTok{alpha =} \DecValTok{1}\NormalTok{/}\DecValTok{3}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{scale_size_area}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-12-1}
\end{figure}

For interactive 3d plots, including true 3d surfaces, see RGL,
\url{http://rgl.neoscientists.org/about.shtml}.

\hyperdef{}{sec:maps}{\section{Drawing maps}\label{sec:maps}}

\index{Maps!geoms} \index{Data!spatial}

There are four types of map data you might want to visualise: vector
boundaries, point metadata, area metadata, and raster images. Typically,
assembling these datasets is the most challenging part of drawing maps.
Unfortunately ggplot2 can't help you with that part of the analysis, but
I'll provide some hints about other R packages that you might want to
look at.

I'll illustrate each of the four types of map data with some maps of
Michigan.

\subsection{Vector boundaries}

Vector boundaries are defined by a data frame with one row for each
``corner'' of a geographical region like a country, state, or county. It
requires four variables:

\begin{itemize}
\tightlist
\item
  \texttt{lat} and \texttt{long}, giving the location of a point.
\item
  \texttt{group}, a unique identifier for each contiguous region.
\item
  \texttt{id}, the name of the region.
\end{itemize}

Separate \texttt{group} and \texttt{id} variables are necessary because
sometimes a geographical unit isn't a contiguous polygon. For example,
Hawaii is composed of multiple islands that can't be drawn using a
single polygon.

The following code extracts that data from the built in maps package
using \texttt{ggplot2::map\_data()}. The maps package isn't particularly
accurate or up-to-date, but it's built into R so it's a reasonable place
to start. \indexf{map\_data}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mi_counties <-}\StringTok{ }\KeywordTok{map_data}\NormalTok{(}\StringTok{"county"}\NormalTok{, }\StringTok{"michigan"}\NormalTok{) %>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\DataTypeTok{lon =} \NormalTok{long, lat, group, }\DataTypeTok{id =} \NormalTok{subregion)}
\KeywordTok{head}\NormalTok{(mi_counties)}
\CommentTok{#>     lon  lat group     id}
\CommentTok{#> 1 -83.9 44.9     1 alcona}
\CommentTok{#> 2 -83.4 44.9     1 alcona}
\CommentTok{#> 3 -83.4 44.9     1 alcona}
\CommentTok{#> 4 -83.3 44.8     1 alcona}
\CommentTok{#> 5 -83.3 44.8     1 alcona}
\CommentTok{#> 6 -83.3 44.8     1 alcona}
\end{Highlighting}
\end{Shaded}

You can visualise vector boundary data with \texttt{geom\_polygon()}:
\indexf{geom\_polygon}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mi_counties, }\KeywordTok{aes}\NormalTok{(lon, lat)) +}
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \NormalTok{group)) +}\StringTok{ }
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}

\KeywordTok{ggplot}\NormalTok{(mi_counties, }\KeywordTok{aes}\NormalTok{(lon, lat)) +}
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \NormalTok{group), }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{, }\DataTypeTok{colour =} \StringTok{"grey50"}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-14-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-14-2}
\end{figure}

Note the use of \texttt{coord\_quickmap()}: it's a quick and dirty
adjustment that ensures that the aspect ratio of the plot is set
correctly.

Other useful sources of vector boundary data are:

\begin{itemize}
\item
  The USAboundaries package,
  \url{https://github.com/ropensci/USAboundaries} which contains state,
  county and zip code data for the US. As well as current boundaries, it
  also has state and county boundaries going back to the 1600s.
\item
  The tigris package, \url{https://github.com/walkerke/tigris}, makes it
  easy to access the US Census TIGRIS shapefiles. It contains state,
  county, zipcode, and census tract boundaries, as well as many other
  useful datasets.
\item
  The rnaturalearth package bundles up the free, high-quality data from
  \url{http://naturalearthdata.com/}. It contains country borders, and
  borders for the top-level region within each country (e.g. states in
  the USA, regions in France, counties in the UK).
\item
  The osmar package, \url{https://cran.r-project.org/package=osmar}
  wraps up the OpenStreetMap API so you can access a wide range of
  vector data including indvidual streets and buildings
\item
  You may have your own shape files (\texttt{.shp}). You can load them
  into R with \texttt{maptools::readShapeSpatial()}.
\end{itemize}

These sources all generate spatial data frames defined by the sp
package. You can convert them into a data frame with \texttt{fortify()}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(USAboundaries)}
\NormalTok{c18 <-}\StringTok{ }\KeywordTok{us_boundaries}\NormalTok{(}\StringTok{"1820-01-01"}\NormalTok{)}
\NormalTok{c18df <-}\StringTok{ }\KeywordTok{fortify}\NormalTok{(c18)}
\CommentTok{#> Regions defined for each Polygons}
\KeywordTok{head}\NormalTok{(c18df)}
\CommentTok{#>    long lat order  hole piece id group}
\CommentTok{#> 1 -87.6  35     1 FALSE     1  4   4.1}
\CommentTok{#> 2 -87.6  35     2 FALSE     1  4   4.1}
\CommentTok{#> 3 -87.6  35     3 FALSE     1  4   4.1}
\CommentTok{#> 4 -87.6  35     4 FALSE     1  4   4.1}
\CommentTok{#> 5 -87.5  35     5 FALSE     1  4   4.1}
\CommentTok{#> 6 -87.3  35     6 FALSE     1  4   4.1}

\KeywordTok{ggplot}\NormalTok{(c18df, }\KeywordTok{aes}\NormalTok{(long, lat)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \NormalTok{group), }\DataTypeTok{colour =} \StringTok{"grey50"}\NormalTok{, }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{) +}
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-15-1}
\end{figure}

\subsection{Point metadata}

Point metadata connects locations (defined by lat and lon) with other
variables. For example, the code below extracts the biggest cities in MI
(as of 2006):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mi_cities <-}\StringTok{ }\NormalTok{maps::us.cities %>%}\StringTok{ }
\StringTok{  }\KeywordTok{tbl_df}\NormalTok{() %>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(country.etc ==}\StringTok{ "MI"}\NormalTok{) %>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(-country.etc, }\DataTypeTok{lon =} \NormalTok{long) %>%}
\StringTok{  }\KeywordTok{arrange}\NormalTok{(}\KeywordTok{desc}\NormalTok{(pop))}
\NormalTok{mi_cities}
\CommentTok{#> Source: local data frame [36 x 5]}
\CommentTok{#> }
\CommentTok{#>                   name    pop   lat   lon capital}
\CommentTok{#>                  (chr)  (int) (dbl) (dbl)   (int)}
\CommentTok{#> 1           Detroit MI 871789  42.4 -83.1       0}
\CommentTok{#> 2      Grand Rapids MI 193006  43.0 -85.7       0}
\CommentTok{#> 3            Warren MI 132537  42.5 -83.0       0}
\CommentTok{#> 4  Sterling Heights MI 127027  42.6 -83.0       0}
\CommentTok{#> 5           Lansing MI 117236  42.7 -84.5       2}
\CommentTok{#> 6             Flint MI 115691  43.0 -83.7       0}
\CommentTok{#> ..                 ...    ...   ...   ...     ...}
\end{Highlighting}
\end{Shaded}

We could show this data with a scatterplot, but it's not terribly useful
without a reference. You almost always combine point metadata with
another layer to make it interpretable.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mi_cities, }\KeywordTok{aes}\NormalTok{(lon, lat)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{size =} \NormalTok{pop)) +}\StringTok{ }
\StringTok{  }\KeywordTok{scale_size_area}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}

\KeywordTok{ggplot}\NormalTok{(mi_cities, }\KeywordTok{aes}\NormalTok{(lon, lat)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \NormalTok{group), mi_counties, }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{, }\DataTypeTok{colour =} \StringTok{"grey50"}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{size =} \NormalTok{pop), }\DataTypeTok{colour =} \StringTok{"red"}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{scale_size_area}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-17-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-17-2}
\end{figure}

\subsection{Raster images}

Instead of displaying context with vector boundaries, you might want to
draw a traditional map underneath. This is called a raster image. The
easiest way to get a raster map of a given area is to use the ggmap
package, which allows you to get data from a variety of online mapping
sources including OpenStreetMap and Google Maps. Downloading the raster
data is often time consuming so it's a good idea to cache it in a rds
file. \index{ggmap} \index{Raster data}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{if (}\KeywordTok{file.exists}\NormalTok{(}\StringTok{"mi_raster.rds"}\NormalTok{)) \{}
  \NormalTok{mi_raster <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\StringTok{"mi_raster.rds"}\NormalTok{)}
\NormalTok{\} else \{}
  \NormalTok{bbox <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}
    \KeywordTok{min}\NormalTok{(mi_counties$lon), }\KeywordTok{min}\NormalTok{(mi_counties$lat), }
    \KeywordTok{max}\NormalTok{(mi_counties$lon), }\KeywordTok{max}\NormalTok{(mi_counties$lat)}
  \NormalTok{)}
  \NormalTok{mi_raster <-}\StringTok{ }\NormalTok{ggmap::}\KeywordTok{get_openstreetmap}\NormalTok{(bbox, }\DataTypeTok{scale =} \DecValTok{8735660}\NormalTok{)}
  \KeywordTok{saveRDS}\NormalTok{(mi_raster, }\StringTok{"mi_raster.rds"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

(Finding the appropriate \texttt{scale} required a lot of manual
tweaking.)

You can then plot it with:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggmap::}\KeywordTok{ggmap}\NormalTok{(mi_raster)}

\NormalTok{ggmap::}\KeywordTok{ggmap}\NormalTok{(mi_raster) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{size =} \NormalTok{pop), mi_cities, }\DataTypeTok{colour =} \StringTok{"red"}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{scale_size_area}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

If you have raster data from the raster package, you can convert it to
the form needed by ggplot2 with the following code:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(raster::}\KeywordTok{rasterToPoints}\NormalTok{(x))}
\KeywordTok{names}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"lon"}\NormalTok{, }\StringTok{"lat"}\NormalTok{, }\StringTok{"x"}\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(lon, lat)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_raster}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \NormalTok{x))}
\end{Highlighting}
\end{Shaded}

\subsection{Area metadata}

Sometimes metadata is associated not with a point, but with an area. For
example, we can create \texttt{mi\_census} which provides census
information about each county in MI:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mi_census <-}\StringTok{ }\NormalTok{midwest %>%}
\StringTok{  }\KeywordTok{tbl_df}\NormalTok{() %>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(state ==}\StringTok{ "MI"}\NormalTok{) %>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{county =} \KeywordTok{tolower}\NormalTok{(county)) %>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(county, area, poptotal, percwhite, percblack)}
\NormalTok{mi_census}
\CommentTok{#> Source: local data frame [83 x 5]}
\CommentTok{#> }
\CommentTok{#>     county  area poptotal percwhite percblack}
\CommentTok{#>      (chr) (dbl)    (int)     (dbl)     (dbl)}
\CommentTok{#> 1   alcona 0.041    10145      98.8     0.266}
\CommentTok{#> 2    alger 0.051     8972      93.9     2.374}
\CommentTok{#> 3  allegan 0.049    90509      95.9     1.600}
\CommentTok{#> 4   alpena 0.034    30605      99.2     0.114}
\CommentTok{#> 5   antrim 0.031    18185      98.4     0.126}
\CommentTok{#> 6   arenac 0.021    14931      98.4     0.067}
\CommentTok{#> ..     ...   ...      ...       ...       ...}
\end{Highlighting}
\end{Shaded}

We can't map this data directly because it has no spatial component.
Instead, we must first join it to the vector boundaries data. This is
not particularly space efficient, but it makes it easy to see exactly
what data is being plotted. Here I use \texttt{dplyr::left\_join()} to
combine the two datasets and create a choropleth map. \index{Choropleth}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{census_counties <-}\StringTok{ }\KeywordTok{left_join}\NormalTok{(mi_census, mi_counties, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{"county"} \NormalTok{=}\StringTok{ "id"}\NormalTok{))}
\NormalTok{census_counties}
\CommentTok{#> Source: local data frame [1,472 x 8]}
\CommentTok{#> }
\CommentTok{#>    county  area poptotal percwhite percblack   lon   lat group}
\CommentTok{#>     (chr) (dbl)    (int)     (dbl)     (dbl) (dbl) (dbl) (dbl)}
\CommentTok{#> 1  alcona 0.041    10145      98.8     0.266 -83.9  44.9     1}
\CommentTok{#> 2  alcona 0.041    10145      98.8     0.266 -83.4  44.9     1}
\CommentTok{#> 3  alcona 0.041    10145      98.8     0.266 -83.4  44.9     1}
\CommentTok{#> 4  alcona 0.041    10145      98.8     0.266 -83.3  44.8     1}
\CommentTok{#> 5  alcona 0.041    10145      98.8     0.266 -83.3  44.8     1}
\CommentTok{#> 6  alcona 0.041    10145      98.8     0.266 -83.3  44.8     1}
\CommentTok{#> ..    ...   ...      ...       ...       ...   ...   ...   ...}

\KeywordTok{ggplot}\NormalTok{(census_counties, }\KeywordTok{aes}\NormalTok{(lon, lat, }\DataTypeTok{group =} \NormalTok{county)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \NormalTok{poptotal)) +}\StringTok{ }
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}

\KeywordTok{ggplot}\NormalTok{(census_counties, }\KeywordTok{aes}\NormalTok{(lon, lat, }\DataTypeTok{group =} \NormalTok{county)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \NormalTok{percwhite)) +}\StringTok{ }
\StringTok{  }\KeywordTok{coord_quickmap}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-22-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-22-2}
\end{figure}

\hyperdef{}{sec:uncertainty}{\section{Revealing
uncertainty}\label{sec:uncertainty}}

If you have information about the uncertainty present in your data,
whether it be from a model or from distributional assumptions, it's a
good idea to display it. There are four basic families of geoms that can
be used for this job, depending on whether the x values are discrete or
continuous, and whether or not you want to display the middle of the
interval, or just the extent:

\begin{itemize}
\tightlist
\item
  Discrete x, range: \texttt{geom\_errorbar()},
  \texttt{geom\_linerange()}
\item
  Discrete x, range \& center: \texttt{geom\_crossbar()},
  \texttt{geom\_pointrange()}
\item
  Continuous x, range: \texttt{geom\_ribbon()}
\item
  Continuous x, range \& center:
  \texttt{geom\_smooth(stat\ =\ "identity")}
\end{itemize}

These geoms assume that you are interested in the distribution of y
conditional on x and use the aesthetics \texttt{ymin} and \texttt{ymax}
to determine the range of the y values. If you want the opposite, see
\hyperref[sub:coord-flip]{coord\_flip}. \index{Error bars}
\indexf{geom\_ribbon} \indexf{geom\_smooth} \indexf{geom\_errorbar}
\indexf{geom\_linerange} \indexf{geom\_crossbar}
\indexf{geom\_pointrange}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{16}\NormalTok{)}
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \DecValTok{1}\NormalTok{:}\DecValTok{3}\NormalTok{, }\DataTypeTok{y =} \NormalTok{y, }\DataTypeTok{se =} \KeywordTok{c}\NormalTok{(}\FloatTok{1.2}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{1.0}\NormalTok{))}

\NormalTok{base <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y, }\DataTypeTok{ymin =} \NormalTok{y -}\StringTok{ }\NormalTok{se, }\DataTypeTok{ymax =} \NormalTok{y +}\StringTok{ }\NormalTok{se))}
\NormalTok{base +}\StringTok{ }\KeywordTok{geom_crossbar}\NormalTok{()}
\NormalTok{base +}\StringTok{ }\KeywordTok{geom_pointrange}\NormalTok{()}
\NormalTok{base +}\StringTok{ }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{stat =} \StringTok{"identity"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.333\linewidth]{_figures/toolbox/unnamed-chunk-23-1}%
  \includegraphics[width=0.333\linewidth]{_figures/toolbox/unnamed-chunk-23-2}%
  \includegraphics[width=0.333\linewidth]{_figures/toolbox/unnamed-chunk-23-3}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{base +}\StringTok{ }\KeywordTok{geom_errorbar}\NormalTok{()}
\NormalTok{base +}\StringTok{ }\KeywordTok{geom_linerange}\NormalTok{()}
\NormalTok{base +}\StringTok{ }\KeywordTok{geom_ribbon}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.333\linewidth]{_figures/toolbox/unnamed-chunk-24-1}%
  \includegraphics[width=0.333\linewidth]{_figures/toolbox/unnamed-chunk-24-2}%
  \includegraphics[width=0.333\linewidth]{_figures/toolbox/unnamed-chunk-24-3}
\end{figure}

Because there are so many different ways to calculate standard errors,
the calculation is up to you. \index{Standard errors} For very simple
cases, ggplot2 provides some tools in the form of summary functions
described below, otherwise you will have to do it yourself.
\hyperref[cha:modelling]{The modelling chapter} contains more advice on
extracting confidence intervals from more sophisticated models.

\hyperdef{}{sec:weighting}{\section{Weighted data}\label{sec:weighting}}

When you have aggregated data where each row in the dataset represents
multiple observations, you need some way to take into account the
weighting variable. We will use some data collected on Midwest states in
the 2000 US census in the built-in \texttt{midwest} data frame. The data
consists mainly of percentages (e.g., percent white, percent below
poverty line, percent with college degree) and some information for each
county (area, total population, population density). \index{Weighting}

There are a few different things we might want to weight by:

\begin{itemize}
\tightlist
\item
  Nothing, to look at numbers of counties.
\item
  Total population, to work with absolute numbers.
\item
  Area, to investigate geographic effects. (This isn't useful for
  \texttt{midwest}, but would be if we had variables like percentage of
  farmland.)
\end{itemize}

The choice of a weighting variable profoundly affects what we are
looking at in the plot and the conclusions that we will draw. There are
two aesthetic attributes that can be used to adjust for weights.
Firstly, for simple geoms like lines and points, use the size aesthetic:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Unweighted}
\KeywordTok{ggplot}\NormalTok{(midwest, }\KeywordTok{aes}\NormalTok{(percwhite, percbelowpoverty)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{()}

\CommentTok{# Weight by population}
\KeywordTok{ggplot}\NormalTok{(midwest, }\KeywordTok{aes}\NormalTok{(percwhite, percbelowpoverty)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{size =} \NormalTok{poptotal /}\StringTok{ }\FloatTok{1e6}\NormalTok{)) +}\StringTok{ }
\StringTok{  }\KeywordTok{scale_size_area}\NormalTok{(}\StringTok{"Population}\CharTok{\textbackslash{}n}\StringTok{(millions)"}\NormalTok{, }\DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/miss-basic-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/miss-basic-2}
\end{figure}

For more complicated grobs which involve some statistical
transformation, we specify weights with the \texttt{weight} aesthetic.
These weights will be passed on to the statistical summary function.
Weights are supported for every case where it makes sense: smoothers,
quantile regressions, boxplots, histograms, and density plots. You can't
see this weighting variable directly, and it doesn't produce a legend,
but it will change the results of the statistical summary. The following
code shows how weighting by population density affects the relationship
between percent white and percent below the poverty line.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Unweighted}
\KeywordTok{ggplot}\NormalTok{(midwest, }\KeywordTok{aes}\NormalTok{(percwhite, percbelowpoverty)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method =} \NormalTok{lm, }\DataTypeTok{size =} \DecValTok{1}\NormalTok{)}

\CommentTok{# Weighted by population}
\KeywordTok{ggplot}\NormalTok{(midwest, }\KeywordTok{aes}\NormalTok{(percwhite, percbelowpoverty)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{size =} \NormalTok{poptotal /}\StringTok{ }\FloatTok{1e6}\NormalTok{)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{weight =} \NormalTok{poptotal), }\DataTypeTok{method =} \NormalTok{lm, }\DataTypeTok{size =} \DecValTok{1}\NormalTok{) +}
\StringTok{  }\KeywordTok{scale_size_area}\NormalTok{(}\DataTypeTok{guide =} \StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/weight-lm-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/weight-lm-2}
\end{figure}

When we weight a histogram or density plot by total population, we
change from looking at the distribution of the number of counties, to
the distribution of the number of people. The following code shows the
difference this makes for a histogram of the percentage below the
poverty line: \index{Histogram!weighted}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(midwest, }\KeywordTok{aes}\NormalTok{(percbelowpoverty)) +}
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{binwidth =} \DecValTok{1}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Counties"}\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{(midwest, }\KeywordTok{aes}\NormalTok{(percbelowpoverty)) +}
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{weight =} \NormalTok{poptotal), }\DataTypeTok{binwidth =} \DecValTok{1}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Population (1000s)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/weight-hist-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/weight-hist-2}
\end{figure}

\hyperdef{}{sec:diamonds}{\section{Diamonds data}\label{sec:diamonds}}

To demonstrate tools for large datasets, we'll use the built in
\texttt{diamonds} dataset, which consists of price and quality
information for \textasciitilde{}54,000 diamonds:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diamonds}
\CommentTok{#> Source: local data frame [53,940 x 10]}
\CommentTok{#> }
\CommentTok{#>    carat       cut  color clarity depth table price     x     y}
\CommentTok{#>    (dbl)    (fctr) (fctr)  (fctr) (dbl) (dbl) (int) (dbl) (dbl)}
\CommentTok{#> 1   0.23     Ideal      E     SI2  61.5    55   326  3.95  3.98}
\CommentTok{#> 2   0.21   Premium      E     SI1  59.8    61   326  3.89  3.84}
\CommentTok{#> 3   0.23      Good      E     VS1  56.9    65   327  4.05  4.07}
\CommentTok{#> 4   0.29   Premium      I     VS2  62.4    58   334  4.20  4.23}
\CommentTok{#> 5   0.31      Good      J     SI2  63.3    58   335  4.34  4.35}
\CommentTok{#> 6   0.24 Very Good      J    VVS2  62.8    57   336  3.94  3.96}
\CommentTok{#> ..   ...       ...    ...     ...   ...   ...   ...   ...   ...}
\CommentTok{#>        z}
\CommentTok{#>    (dbl)}
\CommentTok{#> 1   2.43}
\CommentTok{#> 2   2.31}
\CommentTok{#> 3   2.31}
\CommentTok{#> 4   2.63}
\CommentTok{#> 5   2.75}
\CommentTok{#> 6   2.48}
\CommentTok{#> ..   ...}
\end{Highlighting}
\end{Shaded}

The data contains the four C's of diamond quality: carat, cut, colour
and clarity; and five physical measurements: depth, table, x, y and z,
as described in Figure \ref{fig:diamond-dim}.
\index{Data!diamonds@\texttt{diamonds}}

\begin{figure}[htbp]
  \centering
    \includegraphics[width=0.8\linewidth]{diagrams/diamond-dimensions}
  \caption{How the variables x, y, z, table and depth are measured.}
  \label{fig:diamond-dim}
\end{figure}

The dataset has not been well cleaned, so as well as demonstrating
interesting facts about diamonds, it also shows some data quality
problems.

\hyperdef{}{sec:distributions}{\section{Displaying
distributions}\label{sec:distributions}}

There are a number of geoms that can be used to display distributions,
depending on the dimensionality of the distribution, whether it is
continuous or discrete, and whether you are interested in the
conditional or joint distribution. \index{Distributions}

For 1d continuous distributions the most important geom is the
histogram, \texttt{geom\_histogram()}: \indexf{geom\_histogram}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{()}
\CommentTok{#> `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.}
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{binwidth =} \FloatTok{0.1}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{55}\NormalTok{, }\DecValTok{70}\NormalTok{)}
\CommentTok{#> Warning: Removed 45 rows containing non-finite values (stat_bin).}
\CommentTok{#> Warning: Removed 2 rows containing missing values (geom_bar).}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/geom-1d-con-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/geom-1d-con-2}
\end{figure}

It is important to experiment with binning to find a revealing view. You
can change the \texttt{binwidth}, specify the number of \texttt{bins},
or specify the exact location of the \texttt{breaks}. Never rely on the
default parameters to get a revealing view of the distribution. Zooming
in on the x axis, \texttt{xlim(55,\ 70)}, and selecting a smaller bin
width, \texttt{binwidth\ =\ 0.1}, reveals far more detail.
\index{Histogram!choosing bins}

When publishing figures, don't forget to include information about
important parameters (like bin width) in the caption.

If you want to compare the distribution between groups, you have a few
options:

\begin{itemize}
\tightlist
\item
  Show small multiples of the histogram,
  \texttt{facet\_wrap(\textasciitilde{}\ var)}.
\item
  Use colour and a frequency polygon, \texttt{geom\_freqpoly()} .
  \index{Frequency polygon} \indexf{geom\_freqpoly}
\item
  Use a ``conditional density plot'',
  \texttt{geom\_histogram(position\ =\ "fill")}.
  \index{Conditional density plot}
\end{itemize}

The frequency polygon and conditional density plots are shown below. The
conditional density plot uses \texttt{position\_fill()} to stack each
bin, scaling it to the same height. This plot is perceptually
challenging because you need to compare bar heights, not positions, but
you can see the strongest patterns. \indexf{position\_fill}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_freqpoly}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{colour =} \NormalTok{cut), }\DataTypeTok{binwidth =} \FloatTok{0.1}\NormalTok{, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) +}
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{58}\NormalTok{, }\DecValTok{68}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \NormalTok{cut), }\DataTypeTok{binwidth =} \FloatTok{0.1}\NormalTok{, }\DataTypeTok{position =} \StringTok{"fill"}\NormalTok{,}
    \DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) +}
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{58}\NormalTok{, }\DecValTok{68}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/compare-dist-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/compare-dist-2}
\end{figure}

(I've suppressed the legends to focus on the display of the data.)

Both the histogram and frequency polygon geom use the same underlying
statistical transformation: \texttt{stat\ =\ "bin"}. This statistic
produces two output variables: \texttt{count} and \texttt{density}. By
default, count is mapped to y-position, because it's most interpretable.
The density is the count divided by the total count multiplied by the
bin width, and is useful when you want to compare the shape of the
distributions, not the overall size. \indexf{stat\_bin}

An alternative to a bin-based visualisation is a density estimate.
\texttt{geom\_density()} places a little normal distribution at each
data point and sums up all the curves. It has desirable theoretical
properties, but is more difficult to relate back to the data. Use a
density plot when you know that the underlying density is smooth,
continuous and unbounded. You can use the \texttt{adjust} parameter to
make the density more or less smooth. \index{Density plot}
\indexf{geom\_density}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(depth)) +}
\StringTok{  }\KeywordTok{geom_density}\NormalTok{(}\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{58}\NormalTok{, }\DecValTok{68}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(depth, }\DataTypeTok{fill =} \NormalTok{cut, }\DataTypeTok{colour =} \NormalTok{cut)) +}
\StringTok{  }\KeywordTok{geom_density}\NormalTok{(}\DataTypeTok{alpha =} \FloatTok{0.2}\NormalTok{, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{58}\NormalTok{, }\DecValTok{68}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/geom-density-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/geom-density-2}
\end{figure}

Note that the area of each density estimate is standardised to one so
that you lose information about the relative size of each group.

The histogram, frequency polygon and density display a detailed view of
the distribution. However, sometimes you want to compare many
distributions, and it's useful to have alternative options that
sacrifice quality for quantity. Here are three options:

\begin{itemize}
\item
  \texttt{geom\_boxplot()}: the box-and-whisker plot shows five summary
  statistics along with individual ``outliers''. It displays far less
  information than a histogram, but also takes up much less space.
  \index{Boxplot} \indexf{geom\_boxplot}

  You can use boxplot with both categorical and continuous x. For
  continuous x, you'll also need to set the group aesthetic to define
  how the x variable is broken up into bins. A useful helper function is
  \texttt{cut\_width()}: \indexf{cut\_width}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(clarity, depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{()}
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(carat, depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \KeywordTok{cut_width}\NormalTok{(carat, }\FloatTok{0.1}\NormalTok{))) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\FloatTok{2.05}\NormalTok{)}
\CommentTok{#> Warning: Removed 997 rows containing non-finite values}
\CommentTok{#> (stat_boxplot).}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/geom-boxplot-1}%
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/geom-boxplot-2}
  \end{figure}
\item
  \texttt{geom\_violin()}: the violin plot is a compact version of the
  density plot. The underlying computation is the same, but the results
  are displayed in a similar fashion to the boxplot:
  \indexf{geom\_violion} \index{Violin plot}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(clarity, depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_violin}\NormalTok{()}
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(carat, depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_violin}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{group =} \KeywordTok{cut_width}\NormalTok{(carat, }\FloatTok{0.1}\NormalTok{))) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\FloatTok{2.05}\NormalTok{)}
\CommentTok{#> Warning: Removed 997 rows containing non-finite values}
\CommentTok{#> (stat_ydensity).}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-26-1}%
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-26-2}
  \end{figure}
\item
  \texttt{geom\_dotplot()}: draws one point for each observation,
  carefully adjusted in space to avoid overlaps and show the
  distribution. It is useful for smaller datasets.
  \indexf{geom\_dotplot} \index{Dot plot}
\end{itemize}

\subsection{Exercises}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  What binwidth tells you the most interesting story about the
  distribution of \texttt{carat}?
\item
  Draw a histogram of \texttt{price}. What interesting patterns do you
  see?
\item
  How does the distribution of \texttt{price} vary with
  \texttt{clarity}?
\item
  Overlay a frequency polygon and density plot of \texttt{depth}. What
  computed variable do you need to map to \texttt{y} to make the two
  plots comparable? (You can either modify \texttt{geom\_freqpoly()} or
  \texttt{geom\_density()}.)
\end{enumerate}

\hyperdef{}{sec:overplotting}{\section{Dealing with
overplotting}\label{sec:overplotting}}

The scatterplot is a very important tool for assessing the relationship
between two continuous variables. However, when the data is large,
points will be often plotted on top of each other, obscuring the true
relationship. In extreme cases, you will only be able to see the extent
of the data, and any conclusions drawn from the graphic will be suspect.
This problem is called \textbf{overplotting}. \index{Overplotting}

There are a number of ways to deal with it depending on the size of the
data and severity of the overplotting. The first set of techniques
involves tweaking aesthetic properties. These tend to be most effective
for smaller datasets:

\begin{itemize}
\item
  Very small amounts of overplotting can sometimes be alleviated by
  making the points smaller, or using hollow glyphs. The following code
  shows some options for 2000 points sampled from a bivariate normal
  distribution. \indexf{geom\_point}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{rnorm}\NormalTok{(}\DecValTok{2000}\NormalTok{), }\DataTypeTok{y =} \KeywordTok{rnorm}\NormalTok{(}\DecValTok{2000}\NormalTok{))}
\NormalTok{norm <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(df, }\KeywordTok{aes}\NormalTok{(x, y)) +}\StringTok{ }\KeywordTok{xlab}\NormalTok{(}\OtherTok{NULL}\NormalTok{) +}\StringTok{ }\KeywordTok{ylab}\NormalTok{(}\OtherTok{NULL}\NormalTok{)}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{()}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{shape =} \DecValTok{1}\NormalTok{) }\CommentTok{# Hollow circles}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{shape =} \StringTok{"."}\NormalTok{) }\CommentTok{# Pixel sized}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.333\linewidth]{_figures/toolbox/overp-glyph-1}%
    \includegraphics[width=0.333\linewidth]{_figures/toolbox/overp-glyph-2}%
    \includegraphics[width=0.333\linewidth]{_figures/toolbox/overp-glyph-3}
  \end{figure}
\item
  For larger datasets with more overplotting, you can use alpha blending
  (transparency) to make the points transparent. If you specify
  \texttt{alpha} as a ratio, the denominator gives the number of points
  that must be overplotted to give a solid colour. Values smaller than
  \textasciitilde{}\(1/500\) are rounded down to zero, giving completely
  transparent points. \indexc{alpha} \index{Transparency}
  \index{Colour!transparency} \index{Alpha blending}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{alpha =} \DecValTok{1} \NormalTok{/}\StringTok{ }\DecValTok{3}\NormalTok{)}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{alpha =} \DecValTok{1} \NormalTok{/}\StringTok{ }\DecValTok{5}\NormalTok{)}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{alpha =} \DecValTok{1} \NormalTok{/}\StringTok{ }\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.333\linewidth]{_figures/toolbox/overp-alpha-1}%
    \includegraphics[width=0.333\linewidth]{_figures/toolbox/overp-alpha-2}%
    \includegraphics[width=0.333\linewidth]{_figures/toolbox/overp-alpha-3}
  \end{figure}
\item
  If there is some discreteness in the data, you can randomly jitter the
  points to alleviate some overlaps with \texttt{geom\_jitter()}. This
  can be particularly useful in conjunction with transparency. By
  default, the amount of jitter added is 40\% of the resolution of the
  data, which leaves a small gap between adjacent regions. You can
  override the default with \texttt{width} and \texttt{height}
  arguments.
\end{itemize}

Alternatively, we can think of overplotting as a 2d density estimation
problem, which gives rise to two more approaches:

\begin{itemize}
\item
  Bin the points and count the number in each bin, then visualise that
  count (the 2d generalisation of the histogram),
  \texttt{geom\_bin2d()}. Breaking the plot into many small squares can
  produce distracting visual artefacts. (D. B. Carr et al. 1987)
  suggests using hexagons instead, and this is implemented in
  \texttt{geom\_hex()}, using the \textbf{hexbin} package (D. Carr,
  Lewin-Koh, and Mchler 2014). \index{hexbin}

  The code below compares square and hexagonal bins, using parameters
  \texttt{bins} and \texttt{binwidth} to control the number and size of
  the bins. \index{Histogram!2d} \indexf{geom\_hexagon}
  \indexf{geom\_hex} \indexf{geom\_bin2d}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_bin2d}\NormalTok{()}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_bin2d}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/overp-bin-1}%
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/overp-bin-2}
  \end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_hex}\NormalTok{()}
\NormalTok{norm +}\StringTok{ }\KeywordTok{geom_hex}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

  \begin{figure}[H]
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/overp-bin-hex-1}%
    \includegraphics[width=0.5\linewidth]{_figures/toolbox/overp-bin-hex-2}
  \end{figure}
\item
  Estimate the 2d density with \texttt{stat\_density2d()}, and then
  display using one of the techniques for showing 3d surfaces in
  \hyperref[sec:surface]{surfaces}.
\item
  If you are interested in the conditional distribution of y given x,
  then the techniques of \hyperref[sub:distribution]{displaying
  distributions} will also be useful.
\end{itemize}

Another approach to dealing with overplotting is to add data summaries
to help guide the eye to the true shape of the pattern within the data.
For example, you could add a smooth line showing the centre of the data
with \texttt{geom\_smooth()} or use one of the summaries below.

\hyperdef{}{sec:summary}{\section{Statistical
summaries}\label{sec:summary}}

\indexf{stat\_summary\_bin} \indexf{stat\_summary\_2d}
\index{Stats!summary}

\texttt{geom\_histogram()} and \texttt{geom\_bin2d()} use a familiar
geom, \texttt{geom\_bar()} and \texttt{geom\_raster()}, combined with a
new statistical transformation, \texttt{stat\_bin()} and
\texttt{stat\_bin2d()}. \texttt{stat\_bin()} and \texttt{stat\_bin2d()}
combine the data into bins and count the number of observations in each
bin. But what if we want a summary other than count? So far, we've just
used the default statistical transformation associated with each geom.
Now we're going to explore how to use \texttt{stat\_summary\_bin()} to
\texttt{stat\_summary\_2d()} to compute different summaries.

Let's start with a couple of examples with the diamonds data. The first
example in each pair shows how we can count the number of diamonds in
each bin; the second shows how we can compute the average price.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(color)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{()}

\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(color, price)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{stat =} \StringTok{"summary_bin"}\NormalTok{, }\DataTypeTok{fun.y =} \NormalTok{mean)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-27-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-27-2}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(table, depth)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bin2d}\NormalTok{(}\DataTypeTok{binwidth =} \DecValTok{1}\NormalTok{, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{70}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{ylim}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{70}\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{(diamonds, }\KeywordTok{aes}\NormalTok{(table, depth, }\DataTypeTok{z =} \NormalTok{price)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_raster}\NormalTok{(}\DataTypeTok{binwidth =} \DecValTok{1}\NormalTok{, }\DataTypeTok{stat =} \StringTok{"summary_2d"}\NormalTok{, }\DataTypeTok{fun =} \NormalTok{mean, }
    \DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{xlim}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{70}\NormalTok{) +}\StringTok{ }
\StringTok{  }\KeywordTok{ylim}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{70}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-28-1}%
  \includegraphics[width=0.5\linewidth]{_figures/toolbox/unnamed-chunk-28-2}
\end{figure}

To get more help on the arguments associated with the two
transformations, look at the help for \texttt{stat\_summary\_bin()} and
\texttt{stat\_summary\_2d()}. You can control the size of the bins and
the summary functions. \texttt{stat\_summary\_bin()} can produce
\texttt{y}, \texttt{ymin} and \texttt{ymax} aesthetics, also making it
useful for displaying measures of spread. See the docs for more details.
You'll learn more about how geoms and stats interact in
\hyperref[sec:stat]{stats}.

These summary functions are quite constrained but are often useful for a
quick first pass at a problem. If you find them restraining, you'll need
to do the summaries yourself. See \hyperref[sec:summarise]{group-wise
summaries} for more details.

\hyperdef{}{sec:elsewhere}{\section{Add-on
packages}\label{sec:elsewhere}}

If the built-in tools in ggplot2 don't do what you need, you might want
to use a special purpose tool built into one of the packages built on
top of ggplot2. Some of the packages that I was familiar with when the
book was published include:

\begin{itemize}
\item
  animInt, \url{https://github.com/tdhock/animint}, lets you make you
  ggplot2 graphics interactive, adding querying, filtering and linking.
\item
  GGally, \url{https://github.com/ggobi/ggally}, provides a very
  flexible scatterplot matrix, amongst other tools.
\item
  ggbio, \url{http://www.tengfei.name/ggbio/}, provides a number of
  specialised geoms for genomic data.
\item
  ggdendro, \url{https://github.com/andrie/ggdendro}, turns data from
  tree methods in to data frames that can easily be displayed with
  ggplot2.
\item
  ggfortify, \url{https://github.com/sinhrks/ggfortify}, provides
  fortify and autoplot methods to handle objects from some popular R
  packages.
\item
  ggenealogy, \url{https://cran.r-project.org/package=ggenealogy}, helps
  explore and visualise genealogy data.
\item
  ggmcmc, \url{http://xavier-fim.net/packages/ggmcmc/}, provides a set
  of flexible tools for visualising the samples generated by MCMC
  methods.
\item
  ggparallel, \url{https://cran.r-project.org/package=ggparallel}:
  easily draw parallel coordinates plots, and the closely related
  hammock and common angle plots.
\item
  ggtern, \url{http://www.ggtern.com}, lets you use ggplot2 to draw
  ternary diagrams, used when you have three variables that always sum
  to one.
\item
  ggtree, \url{https://github.com/GuangchuangYu/ggtree}, provides tools
  to view and annotate phylogenetic tree with different types of
  meta-data.
\item
  granovaGG, \url{https://github.com/briandk/granovaGG}, provides tools
  to visualise ANOVA results.
\item
  plotluck, \url{https://github.com/stefan-schroedl/plotluck}: the
  ggplot2 version of Google's ``I'm feeling lucky''. It automatically
  creates plots for one, two or three variables.
\end{itemize}

\section*{References}
\addcontentsline{toc}{section}{References}

\hyperdef{}{ref-carr:1987}{\label{ref-carr:1987}}
Carr, D. B., R. J. Littlefield, W. L. Nicholson, and J. S. Littlefield.
1987. ``Scatterplot Matrix Techniques for Large N.'' \emph{Journal of
the American Statistical Association} 82 (398): 424--36.

\hyperdef{}{ref-hexbin}{\label{ref-hexbin}}
Carr, Dan, Nicholas Lewin-Koh, and Martin Mchler. 2014. \emph{Hexbin:
Hexagonal Binning Routines}.
